# Ultralytics YOLO ðŸš€, AGPL-3.0 license
# RT-DETR-Nano-Hybrid (Manually Scaled)
# Removed MTI/Slice -> Direct connection from Backbone to Head

# Parameters
nc: 1  # number of classes
scales:
  # ç¦æ­¢è‡ªåŠ¨ç¼©æ”¾ï¼Œä¿æŒæ‰‹åŠ¨ç¡¬ç¼–ç çš„é€šé“æ•°
  n: [1.00, 1.00, 9999]

backbone:
  # [from, repeats, module, args]
  # -------------------------------------------------------
  # ä¿æŒä¹‹å‰çš„æ··åˆç¼©æ”¾ç­–ç•¥ï¼š
  # Stem/Stage1: è¾ƒå¤§ (é¿å…æŠ¥é”™ï¼Œä¿ç•™ç‰¹å¾)
  # Stage2/3/4: 0.25x (Nanoçº§åˆ«)
  # -------------------------------------------------------
  
  # === Stage 1 (Stem + P2) ===
  - [-1, 1, HGStem, [32, 48]]      # 0: P2/4 (48ch) - ä¿æŒåŽŸç‰ˆå¤§å°
  - [-1, 2, HGBlock, [32, 64, 3]]  # 1: Stage 1 (64ch) - çº¦0.5x

  # === Stage 2 (P3) ===
  - [-1, 1, DWConv, [128, 3, 2, 1, False]]  # 2: P3/8 (Downsample)
  - [-1, 2, HGBlock, [48, 128, 3]]          # 3: Backbone P3 (128ch) -> ä¾›Headä½¿ç”¨

  # === Stage 3 (P4) ===
  - [-1, 1, DWConv, [256, 3, 2, 1, False]]  # 4: P3/16 (Downsample)
  - [-1, 2, HGBlock, [96, 256, 5, True, False]]   # 5
  - [-1, 2, HGBlock, [96, 256, 5, True, True]]    # 6
  - [-1, 2, HGBlock, [96, 256, 5, True, True]]    # 7: Backbone P4 (256ch) -> ä¾›Headä½¿ç”¨

  # === Stage 4 (P5) ===
  - [-1, 1, DWConv, [512, 3, 2, 1, False]]  # 8: P4/32 (Downsample)
  - [-1, 2, HGBlock, [192, 512, 5, True, False]]  # 9: Backbone P5 (512ch) -> ä¾›Headä½¿ç”¨

head:
  # =========================================================
  # RT-DETR Encoder (AIFI + CCFM)
  # ç›´æŽ¥è¿žæŽ¥ Backbone å±‚çº§: [9, 7, 3]
  # ç»Ÿä¸€æŠ•å½±åˆ° 256 ç»´åº¦
  # =========================================================

  # --- 1. å¤„ç† P5 (Layer 9, 512ch) ---
  - [9, 1, Conv, [256, 1, 1, None, 1, 1, False]]   # 10: input_proj (512->256)
  - [-1, 1, AIFI, [1024, 8]]                       # 11: Transformer Encoder
  - [-1, 1, Conv, [256, 1, 1]]                     # 12: Y5

  # --- 2. å¤„ç† P4 (Layer 7, 256ch) ---
  - [-1, 1, nn.Upsample, [None, 2, 'nearest']]     # 13: Upsample Y5
  - [7, 1, Conv, [256, 1, 1, None, 1, 1, False]]   # 14: input_proj P4 (256->256)
  - [[-2, -1], 1, Concat, [1]]                     # 15: Cat Y5_up + P4
  - [-1, 3, RepC3, [256]]                          # 16: fpn_blocks.0
  - [-1, 1, Conv, [256, 1, 1]]                     # 17: Y4

  # --- 3. å¤„ç† P3 (Layer 3, 128ch) ---
  - [-1, 1, nn.Upsample, [None, 2, 'nearest']]     # 18: Upsample Y4
  - [3, 1, Conv, [256, 1, 1, None, 1, 1, False]]   # 19: input_proj P3 (128->256)
  - [[-2, -1], 1, Concat, [1]]                     # 20: Cat Y4_up + P3
  - [-1, 3, RepC3, [256]]                          # 21: X3 (Output P3 feature)

  # --- 4. PAN (Bottom-up Path) ---
  - [-1, 1, Conv, [256, 3, 2]]   # 22: Downsample X3
  - [[-1, 17], 1, Concat, [1]]   # 23: Cat with Y4 (Layer 17)
  - [-1, 3, RepC3, [256]]        # 24: F4 (Output P4 feature)

  - [-1, 1, Conv, [256, 3, 2]]   # 25: Downsample F4
  - [[-1, 12], 1, Concat, [1]]   # 26: Cat with Y5 (Layer 12)
  - [-1, 3, RepC3, [256]]        # 27: F5 (Output P5 feature)

  # --- Detect Head ---
  # Inputs: X3(21), F4(24), F5(27)
  - [[21, 24, 27], 1, RTDETRDecoder, [nc]]  # 28: Detect