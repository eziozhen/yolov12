# Ultralytics YOLO ğŸš€, AGPL-3.0 license
# RT-DETR-Nano (Manually Scaled) with MTI
# Mode: "White Box" - No auto-scaling, explicit channels/repeats.

# Parameters
nc: 1  # number of classes
scales:
  # å…³é”®ç‚¹ï¼šè®¾ç½®ä¸º 1.0ï¼Œç¦æ­¢è‡ªåŠ¨ç¼©æ”¾
  # [depth, width, max_channels]
  n: [1.00, 1.00, 9999] 

backbone:
  # [from, repeats, module, args]
  # args format for HGBlock: [cm(ä¸­é—´é€šé“), c2(è¾“å‡ºé€šé“), k, light, shortcut]
  # æ‰‹åŠ¨ç¼©æ”¾é€»è¾‘ï¼š
  #   - Repeats: åŸç‰ˆ 6 -> æ”¹ä¸º 2 (Depth ~0.33)
  #   - Channels: åŸç‰ˆ 2048 -> æ”¹ä¸º 512 (Width 0.25)
  
  # === Stage 1 (Stem + P2) ===
  - [-1, 1, HGStem, [32, 48]]      # 0: P2/4 (48ch)
  - [-1, 2, HGBlock, [32, 64, 3]]  # 1: Stage 1 (64ch)

  # === Stage 2 (P3) ===
  # Downsample: 64 -> 128
  - [-1, 1, DWConv, [128, 3, 2, 1, False]]  # 2: P3/8
  # P3 Output: 128 (Target)
  - [-1, 2, HGBlock, [48, 128, 3]]          # 3 (Backbone P3)

  # === Stage 3 (P4) ===
  # Downsample: 128 -> 256
  - [-1, 1, DWConv, [256, 3, 2, 1, False]]  # 4: P3/16
  # P4 Output: 256 (Target)
  - [-1, 2, HGBlock, [96, 256, 5, True, False]]   # 5
  - [-1, 2, HGBlock, [96, 256, 5, True, True]]    # 6
  - [-1, 2, HGBlock, [96, 256, 5, True, True]]    # 7 (Backbone P4)

  # === Stage 4 (P5) ===
  # Downsample: 256 -> 512
  - [-1, 1, DWConv, [512, 3, 2, 1, False]]  # 8: P4/32
  # P5 Output: 512 (Target)
  - [-1, 2, HGBlock, [192, 512, 5, True, False]]  # 9 (Backbone P5)

head:
  # =========================================================
  # Step 1: é¢„å¤„ç† (Slice First ç­–ç•¥)
  # =========================================================
  # MTI åˆ†æ”¯ (MAE æ¨¡å¼)
  - [9, 1, MTI_Block, [512, 5, 4]] # 10: MTI P5
  - [10, 1, Conv, [256, 1, 1]]     # 11: MTI P5 Proj

  - [7, 1, MTI_Block, [256, 5, 4]] # 12: MTI P4
  
  # çº¯å‡€åˆ‡ç‰‡åˆ†æ”¯
  - [9, 1, TemporalSlice, [5]]     # 13: Slice P5
  - [7, 1, TemporalSlice, [5]]     # 14: Slice P4
  - [3, 1, TemporalSlice, [5]]     # 15: Slice P3

  # =========================================================
  # Step 2: ç©ºé—´åˆ†æ”¯ & MAE ä¸“ç”¨èåˆ
  # =========================================================
  
  # --- P5 å¤„ç† ---
  - [13, 1, Conv, [256, 1, 1, None, 1, 1, False]] # 16: Input Proj
  - [-1, 1, AIFI, [1024, 8]]                      # 17: AIFI (B=16)
  
  # ã€P5 èåˆã€‘: AIFI(17) + MTI_MAE(11)
  - [[-1, 11], 1, Concat, [1]]                    # 18
  # [æ”¹åŠ¨ 1] ä½¿ç”¨ RepC3 ä»£æ›¿ 1x1 Conv
  # 3x3 å·ç§¯èƒ½åˆ©ç”¨å‘¨å›´åƒç´ ä¿¡æ¯ï¼Œä¿®å¤ MAE çš„å•ç‚¹é®æŒ¡é—®é¢˜
  - [-1, 1, RepC3, [256]]                         # 19: Fuse
  # [æ”¹åŠ¨ 2] åŠ å…¥ CBAM æ³¨æ„åŠ› (ç©ºé—´+é€šé“)
  # å¸®åŠ©ç½‘ç»œå¿½ç•¥ MAE çš„ Mask Token åŒºåŸŸï¼Œèšç„¦æœ‰æ•ˆé‡å»ºåŒºåŸŸ
  - [-1, 1, CBAM, [256]]                          # 20: Attention Clean

  # --- P4 å¤„ç† ---
  - [20, 1, nn.Upsample, [None, 2, 'nearest']]    # 21: Up Y5
  
  - [14, 1, Conv, [256, 1, 1, None, 1, 1, False]] # 22: Proj P4
  
  # ã€P4 èåˆã€‘: Proj_P4(22) + MTI_MAE(12)
  - [[-1, 12], 1, Concat, [1]]                    # 23
  # [æ”¹åŠ¨] åŒæ ·ä½¿ç”¨ RepC3 + CBAM å¼ºåŠ›æ¸…æ´—èåˆ
  - [-1, 1, RepC3, [256]]                         # 24: Fuse
  - [-1, 1, CBAM, [256]]                          # 25: Attention Clean
  
  # FPN èåˆ (Top-down)
  - [[21, 25], 1, Concat, [1]]                    # 26
  - [-1, 3, RepC3, [256]]                         # 27: FPN Block
  - [-1, 1, Conv, [256, 1, 1]]                    # 28: Y4

  # --- P3 å¤„ç† ---
  - [-1, 1, nn.Upsample, [None, 2, 'nearest']]    # 29: Up Y4
  - [15, 1, Conv, [256, 1, 1, None, 1, 1, False]] # 30: Proj P3
  
  # FPN èåˆ
  - [[-1, 29], 1, Concat, [1]]                    # 31
  - [-1, 3, RepC3, [256]]                         # 32: X3

  # =========================================================
  # Step 3: PAN (Bottom-up)
  # =========================================================
  - [-1, 1, Conv, [256, 3, 2]]                    # 33
  - [[-1, 28], 1, Concat, [1]]                    # 34: Cat Y4
  - [-1, 3, RepC3, [256]]                         # 35: F4

  - [-1, 1, Conv, [256, 3, 2]]                    # 36
  - [[-1, 20], 1, Concat, [1]]                    # 37: Cat Y5 (æ³¨æ„è¿ Layer 20, CBAM åçš„ç»“æœ)
  - [-1, 3, RepC3, [256]]                         # 38: F5

  # =========================================================
  # Detect
  # =========================================================
  - [[32, 35, 38], 1, RTDETRDecoder, [nc]]